#!/bin/sh
# UNRDF Pre-Push Hook - Full Tier
# DfLSS: Comprehensive validation before sharing code
# 80/20: Catch remaining defects in <60 seconds
#
# This hook runs comprehensive validation before each push:
# - Format check
# - Lint check
# - Build check
# - Unit tests
#
# To bypass temporarily (DISCOURAGED): SKIP_PRE_PUSH=1 git push
# To remove hook: rm .git/hooks/pre-push

set -e

# Allow bypass for emergency situations only
if [ -n "${SKIP_PRE_PUSH:-}" ]; then
    echo "‚ö†Ô∏è  WARNING: Skipping pre-push validation (SKIP_PRE_PUSH set)"
    echo "This is DISCOURAGED. Fix issues before pushing."
    exit 0
fi

echo "üö¶ Pre-push validation (full tier: <60s)..."
echo ""

# Helper function to run command with optional timeout
run_with_timeout() {
    local timeout_seconds=$1
    shift
    local cmd="$@"
    
    if command -v timeout >/dev/null 2>&1; then
        timeout "${timeout_seconds}s" $cmd 2>&1 || return $?
    else
        $cmd 2>&1 || return $?
    fi
}

# Gate 1: Format Check (5s timeout)
echo "Gate 1/4: Format Check..."
FMT_OUTPUT=$(run_with_timeout 5 pnpm format:check) || FMT_EXIT=$?
if [ -z "${FMT_EXIT:-}" ]; then
    echo "‚úÖ Gate 1 passed"
else
    echo "‚ùå ERROR: Code is not formatted"
    echo ""
    echo "Last 10 lines of format output:"
    echo "$FMT_OUTPUT" | tail -10
    echo ""
    echo "Run 'pnpm format' to fix formatting issues"
    exit 1
fi
echo ""

# Gate 2: Lint Check (10s timeout)
echo "Gate 2/4: Lint Check..."
LINT_OUTPUT=$(run_with_timeout 10 pnpm lint) || LINT_EXIT=$?
if [ -z "${LINT_EXIT:-}" ]; then
    echo "‚úÖ Gate 2 passed"
else
    echo "‚ùå ERROR: Lint check failed"
    echo ""
    echo "Last 30 lines of lint output:"
    echo "$LINT_OUTPUT" | tail -30
    echo ""
    echo "Run 'pnpm lint' to see full details"
    echo "Run 'pnpm lint:fix' to auto-fix some issues"
    exit 1
fi
echo ""

# Gate 3: Build Check (15s timeout)
echo "Gate 3/4: Build Check..."
BUILD_OUTPUT=$(run_with_timeout 15 pnpm build) || BUILD_EXIT=$?
if [ -z "${BUILD_EXIT:-}" ]; then
    echo "‚úÖ Gate 3 passed"
else
    echo "‚ùå ERROR: Build failed"
    echo ""
    echo "Last 20 lines of build output:"
    echo "$BUILD_OUTPUT" | tail -20
    echo ""
    echo "Run 'pnpm build' to see full details"
    exit 1
fi
echo ""

# Gate 4: Unit Tests (30s timeout)
echo "Gate 4/4: Unit Tests..."
TEST_OUTPUT=$(run_with_timeout 30 pnpm test) || TEST_EXIT=$?
if [ -z "${TEST_EXIT:-}" ]; then
    echo "‚úÖ Gate 4 passed"
else
    echo "‚ùå ERROR: Tests failed"
    echo ""
    echo "Last 30 lines of test output:"
    echo "$TEST_OUTPUT" | tail -30
    echo ""
    echo "Run 'pnpm test' to see full details"
    exit 1
fi
echo ""

echo "üéâ All pre-push validation gates passed!"
echo ""
echo "Your code is ready to push. Proceeding with push..."

exit 0

