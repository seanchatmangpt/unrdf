# Dockerfile for KGC Sidecar Testcontainer
# Simplified container for E2E testing of Knowledge Graph Core library

FROM node:20-alpine

# Install system dependencies
RUN apk add --no-cache \
    git \
    curl \
    bash

# Create app directory
WORKDIR /app

# Copy project package files
COPY package.json pnpm-lock.yaml* ./

# Install dependencies
RUN npm install -g pnpm && \
    pnpm install --frozen-lockfile || npm install

# Copy source code
COPY src ./src
COPY test/e2e/fixtures ./fixtures
COPY test/e2e/config ./config

# Create simple HTTP server for health checks
RUN printf '%s\n' \
  "import http from 'http';" \
  "" \
  "const server = http.createServer((req, res) => {" \
  "  if (req.url === '/health' || req.url === '/api/health') {" \
  "    res.writeHead(200, { 'Content-Type': 'application/json' });" \
  "    res.end(JSON.stringify({ status: 'healthy', service: 'kgc-sidecar' }));" \
  "  } else {" \
  "    res.writeHead(404);" \
  "    res.end('Not Found');" \
  "  }" \
  "});" \
  "" \
  "server.listen(3000, () => {" \
  "  console.log('KGC Sidecar listening on port 3000');" \
  "});" \
  > server.mjs

# Expose ports
EXPOSE 3000

# Set environment
ENV NODE_ENV=test

# Start simple server (test code will interact with mounted source)
CMD ["node", "server.mjs"]
