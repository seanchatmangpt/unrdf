/**
 * @fileoverview Adapter generation for legacy-substrate translation
 * @module agent-8/adapter-generator
 */

/**
 * Generate adapter for an operation
 * Adapters translate between legacy and substrate formats
 *
 * @param {string} operation - Operation name
 * @param {Object} lens - Lens definition for operation
 * @returns {Object} Adapter functions
 */
export function generateAdapter(operation, lens) {
  return {
    name: `${operation}Adapter`,
    operation,
    toSubstrate: generateToSubstrate(lens),
    fromSubstrate: generateFromSubstrate(lens),
    metadata: {
      generatedAt: new Date().toISOString(),
      lensType: lens.type
    }
  };
}

/**
 * Generate toSubstrate adapter function
 *
 * @param {Object} lens - Lens definition
 * @returns {Function} Adapter function
 */
function generateToSubstrate(lens) {
  const { view, review } = lens;

  return function toSubstrate(legacyInput) {
    try {
      // Apply lens view to transform legacy -> substrate
      const substrateFormat = view(legacyInput);

      return {
        success: true,
        data: substrateFormat
      };
    } catch (error) {
      return {
        success: false,
        error: error.message,
        input: legacyInput
      };
    }
  };
}

/**
 * Generate fromSubstrate adapter function
 *
 * @param {Object} lens - Lens definition
 * @returns {Function} Adapter function
 */
function generateFromSubstrate(lens) {
  const { view, review } = lens;

  return function fromSubstrate(substrateOutput) {
    try {
      // Apply lens review to transform substrate -> legacy
      const legacyFormat = review(substrateOutput);

      return {
        success: true,
        data: legacyFormat
      };
    } catch (error) {
      return {
        success: false,
        error: error.message,
        input: substrateOutput
      };
    }
  };
}

/**
 * Generate adapter module code as string
 *
 * @param {string} domain - Domain name
 * @param {Array<Object>} lenses - Array of lens definitions
 * @returns {string} Adapter module code
 */
export function generateAdapterModule(domain, lenses) {
  const adapters = lenses.map(lens => {
    const { operation } = lens;
    return `
/**
 * Adapter for ${operation} operation
 */
export const ${operation}Adapter = {
  name: '${operation}Adapter',
  operation: '${operation}',

  /**
   * Convert legacy input to substrate format
   *
   * @param {*} legacyInput - Legacy format input
   * @returns {Object} Substrate format
   */
  toSubstrate(legacyInput) {
    try {
      // Transform using lens view
      const result = ${generateViewTransform(lens)};
      return { success: true, data: result };
    } catch (error) {
      return { success: false, error: error.message };
    }
  },

  /**
   * Convert substrate output to legacy format
   *
   * @param {*} substrateOutput - Substrate format output
   * @returns {Object} Legacy format
   */
  fromSubstrate(substrateOutput) {
    try {
      // Transform using lens review
      const result = ${generateReviewTransform(lens)};
      return { success: true, data: result };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }
};`;
  }).join('\n');

  return `/**
 * @fileoverview ${domain} domain adapters
 * Generated by Agent 8 - Domain Kit Generator
 */

${adapters}

/**
 * Get all adapters for domain
 *
 * @returns {Array<Object>} All adapters
 */
export function getAllAdapters() {
  return [
    ${lenses.map(l => `${l.operation}Adapter`).join(',\n    ')}
  ];
}
`;
}

/**
 * Generate view transform code
 *
 * @param {Object} lens - Lens definition
 * @returns {string} Transform code
 */
function generateViewTransform(lens) {
  const { view } = lens;

  if (typeof view === 'function') {
    return `(${view.toString()})(legacyInput)`;
  }

  // Default passthrough
  return 'legacyInput';
}

/**
 * Generate review transform code
 *
 * @param {Object} lens - Lens definition
 * @returns {string} Transform code
 */
function generateReviewTransform(lens) {
  const { review } = lens;

  if (typeof review === 'function') {
    return `(${review.toString()})(substrateOutput)`;
  }

  // Default passthrough
  return 'substrateOutput';
}

/**
 * Generate error handling wrapper
 *
 * @param {string} operation - Operation name
 * @returns {string} Error handling code
 */
export function generateErrorHandling(operation) {
  return `
/**
 * Execute ${operation} with error handling
 *
 * @param {*} input - Input data
 * @param {Function} transform - Transform function
 * @returns {Object} Result with error handling
 */
function executeWithErrorHandling(input, transform) {
  try {
    const result = transform(input);
    return { success: true, data: result };
  } catch (error) {
    return {
      success: false,
      error: error.message,
      operation: '${operation}',
      timestamp: new Date().toISOString()
    };
  }
}`;
}

/**
 * Generate batch adapter for multiple operations
 *
 * @param {Array<Object>} lenses - Array of lenses
 * @returns {Array<Object>} Array of adapters
 */
export function generateBatchAdapters(lenses) {
  return lenses.map(lens => generateAdapter(lens.operation, lens));
}
