<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UNRDF Browser Example - Vanilla JS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h2 {
      color: #444;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #218838;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn-warning:hover:not(:disabled) {
      background: #e0a800;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #c82333;
    }

    .output {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .status {
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border-left: 4px solid #007bff;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .loader {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>UNRDF v3.1.0 Browser Example</h1>
  <p class="subtitle">Vanilla JavaScript + IndexedDB + Web Workers</p>

  <!-- Status Card -->
  <div class="card">
    <h2>System Status</h2>
    <div id="status" class="status info">
      Initializing...
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Engine Status</div>
        <div class="stat-value" id="engine-status">Not Ready</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Triples</div>
        <div class="stat-value" id="triple-count">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Storage Used</div>
        <div class="stat-value" id="storage-used">0 KB</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Queries Run</div>
        <div class="stat-value" id="query-count">0</div>
      </div>
    </div>
  </div>

  <!-- Actions Card -->
  <div class="card">
    <h2>Actions</h2>
    <div class="button-group">
      <button id="init-btn" class="btn-primary">1. Initialize Engine</button>
      <button id="add-data-btn" class="btn-success" disabled>2. Add Sample Data</button>
      <button id="query-btn" class="btn-primary" disabled>3. Run Query</button>
      <button id="validate-btn" class="btn-warning" disabled>4. Validate Data</button>
      <button id="profile-btn" class="btn-primary" disabled>5. Show Performance</button>
      <button id="clear-btn" class="btn-danger" disabled>Clear All Data</button>
    </div>
  </div>

  <!-- Results Card -->
  <div class="card">
    <h2>Results</h2>
    <div id="results" class="output">
Click "Initialize Engine" to get started...
    </div>
  </div>

  <script type="module">
    // Use unpkg for demo (in production, use bundler)
    import {
      createBrowserKnowledgeEngine,
      parseTurtle
    } from 'https://unpkg.com/unrdf@3.1.0/browser';

    // State
    let engine = null;
    let queryCount = 0;

    // DOM elements
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const engineStatusEl = document.getElementById('engine-status');
    const tripleCountEl = document.getElementById('triple-count');
    const storageUsedEl = document.getElementById('storage-used');
    const queryCountEl = document.getElementById('query-count');

    const initBtn = document.getElementById('init-btn');
    const addDataBtn = document.getElementById('add-data-btn');
    const queryBtn = document.getElementById('query-btn');
    const validateBtn = document.getElementById('validate-btn');
    const profileBtn = document.getElementById('profile-btn');
    const clearBtn = document.getElementById('clear-btn');

    // Helper functions
    function setStatus(message, type = 'info') {
      statusEl.className = `status ${type}`;
      statusEl.innerHTML = type === 'loading'
        ? `<span class="loader"></span> ${message}`
        : message;
    }

    function setResults(content) {
      resultsEl.textContent = content;
    }

    function setResultsHTML(html) {
      resultsEl.innerHTML = html;
    }

    async function updateStats() {
      if (!engine) return;

      try {
        // Get triple count
        const countResult = await engine.query({
          query: 'SELECT (COUNT(*) as ?count) WHERE { ?s ?p ?o }',
          type: 'sparql-select'
        });
        tripleCountEl.textContent = countResult[0]?.count || 0;

        // Get storage usage
        const quota = await engine.getStorageQuota();
        const usedMB = (quota.used / 1024 / 1024).toFixed(2);
        storageUsedEl.textContent = `${usedMB} MB`;

        // Query count
        queryCountEl.textContent = queryCount;
      } catch (err) {
        console.error('Failed to update stats:', err);
      }
    }

    // 1. Initialize Engine
    initBtn.addEventListener('click', async () => {
      try {
        setStatus('Initializing knowledge engine...', 'loading');
        setResults('Initializing...');

        engine = await createBrowserKnowledgeEngine({
          storage: {
            type: 'indexeddb',
            name: 'unrdf-demo-graph',
            quota: 50 * 1024 * 1024  // 50MB
          },
          workers: {
            enabled: true,
            maxWorkers: navigator.hardwareConcurrency || 4
          },
          profiling: {
            enabled: true,
            slowQueryThreshold: 100
          }
        });

        setStatus('Knowledge engine ready! âœ…', 'success');
        setResults('Knowledge engine initialized successfully!\n\nFeatures enabled:\n- IndexedDB persistent storage\n- Web Worker query execution\n- Performance profiling\n\nClick "Add Sample Data" to continue...');

        // Enable next buttons
        addDataBtn.disabled = false;
        queryBtn.disabled = false;
        validateBtn.disabled = false;
        profileBtn.disabled = false;
        clearBtn.disabled = false;
        initBtn.disabled = true;

        // Update stats
        engineStatusEl.textContent = 'Ready âœ…';
        await updateStats();

      } catch (err) {
        setStatus(`Initialization failed: ${err.message}`, 'error');
        setResults(`Error: ${err.message}\n\n${err.stack}`);
      }
    });

    // 2. Add Sample Data
    addDataBtn.addEventListener('click', async () => {
      try {
        setStatus('Adding sample data...', 'loading');

        const ttl = `
@prefix ex: <http://example.org/> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

ex:alice a foaf:Person ;
         foaf:name "Alice" ;
         foaf:age "30"^^xsd:integer ;
         foaf:knows ex:bob, ex:charlie .

ex:bob a foaf:Person ;
       foaf:name "Bob" ;
       foaf:age "25"^^xsd:integer ;
       foaf:knows ex:alice .

ex:charlie a foaf:Person ;
           foaf:name "Charlie" ;
           foaf:age "35"^^xsd:integer ;
           foaf:knows ex:alice .

ex:company a foaf:Organization ;
           foaf:name "Acme Corp" ;
           foaf:member ex:alice, ex:bob .
        `;

        const store = await parseTurtle(ttl);

        await engine.executeTransaction({
          additions: [...store],
          removals: [],
          actor: 'browser-demo'
        });

        setStatus('Sample data added successfully! âœ…', 'success');
        setResults(`Added sample data:\n\n${ttl}\n\nTotal: ${[...store].length} triples added.\n\nClick "Run Query" to query the data...`);

        await updateStats();

      } catch (err) {
        setStatus(`Failed to add data: ${err.message}`, 'error');
        setResults(`Error: ${err.message}\n\n${err.stack}`);
      }
    });

    // 3. Run Query
    queryBtn.addEventListener('click', async () => {
      try {
        setStatus('Running SPARQL query...', 'loading');

        const query = `
PREFIX foaf: <http://xmlns.com/foaf/0.1/>
SELECT ?person ?name ?age ?friendName
WHERE {
  ?person a foaf:Person ;
          foaf:name ?name ;
          foaf:age ?age ;
          foaf:knows ?friend .
  ?friend foaf:name ?friendName .
}
ORDER BY DESC(?age)
        `;

        const startTime = performance.now();
        const results = await engine.query({
          query,
          type: 'sparql-select'
        });
        const duration = (performance.now() - startTime).toFixed(2);

        queryCount++;

        setStatus(`Query executed successfully in ${duration}ms! âœ…`, 'success');

        // Build table HTML
        if (results.length > 0) {
          const keys = Object.keys(results[0]);
          let tableHTML = `<table>
            <thead>
              <tr>${keys.map(k => `<th>${k}</th>`).join('')}</tr>
            </thead>
            <tbody>
              ${results.map(row =>
                `<tr>${keys.map(k => `<td>${row[k]}</td>`).join('')}</tr>`
              ).join('')}
            </tbody>
          </table>`;

          tableHTML = `
<strong>Query:</strong>
<pre>${query}</pre>

<strong>Results (${results.length} rows in ${duration}ms):</strong>

${tableHTML}
          `;

          setResultsHTML(tableHTML);
        } else {
          setResults('No results found.');
        }

        await updateStats();

      } catch (err) {
        setStatus(`Query failed: ${err.message}`, 'error');
        setResults(`Error: ${err.message}\n\n${err.stack}`);
      }
    });

    // 4. Validate Data
    validateBtn.addEventListener('click', async () => {
      try {
        setStatus('Running SHACL validation...', 'loading');

        const shapeTtl = `
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix ex: <http://example.org/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

ex:PersonShape a sh:NodeShape ;
  sh:targetClass foaf:Person ;
  sh:property [
    sh:path foaf:name ;
    sh:minCount 1 ;
    sh:datatype xsd:string ;
    sh:message "Person must have a name (string)" ;
  ] ;
  sh:property [
    sh:path foaf:age ;
    sh:datatype xsd:integer ;
    sh:minInclusive 0 ;
    sh:maxInclusive 150 ;
    sh:message "Age must be an integer between 0 and 150" ;
  ] .
        `;

        const shapes = await parseTurtle(shapeTtl);
        const validation = await engine.validate({ shapesGraph: shapes });

        if (validation.conforms) {
          setStatus('Validation passed! âœ…', 'success');
          setResults(`âœ… Validation Successful!\n\nAll data conforms to SHACL shapes.\n\nShapes validated:\n${shapeTtl}`);
        } else {
          setStatus('Validation failed âŒ', 'error');
          const violations = JSON.stringify(validation.results, null, 2);
          setResults(`âŒ Validation Failed\n\nViolations found:\n\n${violations}`);
        }

      } catch (err) {
        setStatus(`Validation error: ${err.message}`, 'error');
        setResults(`Error: ${err.message}\n\n${err.stack}`);
      }
    });

    // 5. Show Performance Profile
    profileBtn.addEventListener('click', async () => {
      try {
        setStatus('Generating performance profile...', 'loading');

        const profile = await engine.getPerformanceProfile();

        const report = `
ðŸ“Š PERFORMANCE PROFILE

Latency Metrics:
  p50 (median):     ${profile.latency.p50.toFixed(2)}ms
  p95:              ${profile.latency.p95.toFixed(2)}ms
  p99:              ${profile.latency.p99.toFixed(2)}ms
  Max:              ${profile.latency.max.toFixed(2)}ms
  Mean:             ${profile.latency.mean.toFixed(2)}ms

Memory Usage:
  Heap Used:        ${(profile.memory.heapUsed / 1024 / 1024).toFixed(2)} MB
  Heap Total:       ${(profile.memory.heapTotal / 1024 / 1024).toFixed(2)} MB
  External:         ${(profile.memory.external / 1024 / 1024).toFixed(2)} MB
  GC Pressure:      ${(profile.memory.gcPressure * 100).toFixed(1)}%

Cache Stats:
  Hit Rate:         ${(profile.cache.hitRate * 100).toFixed(1)}%
  Size:             ${profile.cache.size} entries
  Evictions:        ${profile.cache.evictions}

Query Stats:
  Total Queries:    ${queryCount}
  Slow Queries:     ${profile.slowQueries.length}

${profile.slowQueries.length > 0 ? `
Slow Queries (>${profile.slowQueryThreshold}ms):
${profile.slowQueries.map(q => `  - ${q.duration.toFixed(2)}ms: ${q.query.slice(0, 80)}...`).join('\n')}
` : ''}
        `;

        setStatus('Performance profile ready! âœ…', 'success');
        setResults(report);

      } catch (err) {
        setStatus(`Profiling error: ${err.message}`, 'error');
        setResults(`Error: ${err.message}\n\n${err.stack}`);
      }
    });

    // 6. Clear All Data
    clearBtn.addEventListener('click', async () => {
      try {
        if (!confirm('Clear all data from IndexedDB? This cannot be undone.')) {
          return;
        }

        setStatus('Clearing all data...', 'loading');

        await engine.clearAll();
        queryCount = 0;

        setStatus('All data cleared! âœ…', 'success');
        setResults('All data has been cleared from IndexedDB.\n\nClick "Add Sample Data" to add new data.');

        await updateStats();

      } catch (err) {
        setStatus(`Failed to clear data: ${err.message}`, 'error');
        setResults(`Error: ${err.message}\n\n${err.stack}`);
      }
    });

    // Initialize on load
    setStatus('Click "Initialize Engine" to get started!', 'info');
  </script>
</body>
</html>
