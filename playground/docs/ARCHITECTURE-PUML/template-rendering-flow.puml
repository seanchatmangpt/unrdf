@startuml template-rendering-flow
!theme plain
title Template Rendering Flow - Paper Generation Process

skinparam backgroundColor #FFFFFF
skinparam activityArrowThickness 2
skinparam roundcorner 10

start

:Receive generation request;

partition "Input Processing" {
    :Parse CLI arguments;
    :Validate with Zod schema;

    if (Valid input?) then (yes)
        :Extract paper metadata;
    else (no)
        :Return E_VALIDATION;
        stop
    endif
}

partition "Family Resolution" {
    :Lookup paper family;
    note right
        Families:
        - imrad
        - dsr
        - argument
        - contribution
    end note

    if (Family found?) then (yes)
        :Load family configuration;
    else (no)
        :Return E_UNKNOWN_FAMILY;
        stop
    endif
}

partition "Context Building" {
    :Create template context;

    :Add paper metadata|
    - id
    - title
    - authors
    - abstract;

    :Add family sections|
    - section names
    - section order;

    :Add timestamp and version;
}

partition "Template Loading" {
    :Resolve template path;

    if (Template exists?) then (yes)
        :Load template file;
    else (no)
        :Return E_TEMPLATE_NOT_FOUND;
        stop
    endif

    :Compile Nunjucks template;

    if (Compile success?) then (yes)
        :Template ready;
    else (no)
        :Return E_TEMPLATE_SYNTAX;
        stop
    endif
}

partition "Rendering" {
    :Apply custom filters|
    - latex_escape
    - section_number
    - date_format
    - author_list;

    :Execute Nunjucks render;

    if (Render success?) then (yes)
        :Rendered output ready;
    else (no)
        :Return E_RENDER_ERROR;
        stop
    endif
}

partition "Output" {
    if (--output specified?) then (yes)
        :Write to file;
        if (Write success?) then (yes)
            :File written;
        else (no)
            :Return E_WRITE_ERROR;
            stop
        endif
    else (no)
        :Output to stdout;
    endif

    if (--format json?) then (yes)
        :Format as JSON;
    else (no)
        :Format as LaTeX;
    endif
}

:Return success with paper object;

stop

@enduml
