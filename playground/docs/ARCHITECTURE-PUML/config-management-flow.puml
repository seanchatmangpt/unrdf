@startuml config-management-flow
!theme plain
title Configuration Management Flow - Config Propagation

skinparam backgroundColor #FFFFFF
skinparam activityArrowThickness 2
skinparam roundcorner 10

start

partition "Config Resolution" {
    :Check --config flag;

    if (Custom config path?) then (yes)
        :Use specified path;
    else (no)
        :Use default locations|
        1. ./playground.config.json
        2. ~/.playground/config.json
        3. /etc/playground/config.json;
    endif

    if (Config file exists?) then (yes)
        :Load config file;
        :Parse JSON;
        if (Valid JSON?) then (yes)
            :Config loaded;
        else (no)
            #yellow:Warning: Invalid config|
            Using defaults;
        endif
    else (no)
        :Use default config;
    endif
}

partition "Config Merge" {
    :Load default values;

    note right
        Defaults:
        author.name: "Unknown Author"
        output.format: "latex"
        cli.verbose: false
        ontology.path: "./ontologies/..."
    end note

    :Merge file config over defaults;

    :Check environment variables;
    note right
        PLAYGROUND_AUTHOR_NAME
        PLAYGROUND_OUTPUT_FORMAT
        PLAYGROUND_VERBOSE
    end note

    :Merge env vars over file config;

    :Apply CLI flag overrides;
    note right
        --config
        --verbose
        --format
        --output
    end note

    :Final merged config ready;
}

partition "Config Operations" {
    switch (Operation)

    case ( config set )
        :Validate key format|
        ^[a-z]+(\.[a-z]+)*$;

        if (Valid key?) then (yes)
            :Read current config;
            :Update value;
            :Write to file (atomic);
            :Confirm change;
        else (no)
            #pink:E_INVALID_KEY;
            stop
        endif

    case ( config get )
        :Lookup key;

        if (Key exists?) then (yes)
            :Return value;
        else (no)
            #pink:E_KEY_NOT_FOUND;
            stop
        endif

    case ( config list )
        :Read all config;
        :Group by category;
        :Format output;
        :Display config;

    case ( config reset )
        if (--key specified?) then (yes)
            :Reset single key;
        else (no)
            if (--confirm?) then (yes)
                :Backup current config;
                :Write defaults;
                :Confirm reset;
            else (no)
                :Prompt for confirmation;
            endif
        endif

    endswitch
}

partition "Config Propagation" {
    :Config change detected;

    :Notify dependent components|
    - Template loader
    - SPARQL executor
    - File writer;

    :Invalidate caches;

    :Log config change to telemetry;
}

stop

legend right
    |= Priority |= Source |
    | 1 (highest) | CLI flags |
    | 2 | Environment variables |
    | 3 | Config file |
    | 4 (lowest) | Defaults |
endlegend

@enduml
