{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://knowd.dev/pack-schema-v1.json",
  "title": "Knowd Policy Pack Schema v1",
  "description": "Schema for Knowd policy packs defining queries, hooks, shapes, and configuration",
  "type": "object",
  "properties": {
    "version": {
      "type": "string",
      "description": "Pack version",
      "pattern": "^v\\d+\\.\\d+\\.\\d+$"
    },
    "name": {
      "type": "string",
      "description": "Pack name"
    },
    "description": {
      "type": "string",
      "description": "Pack description"
    },
    "queries": {
      "type": "object",
      "description": "Named SPARQL queries",
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_]*$": {
          "type": "object",
          "properties": {
            "query": {
              "type": "string",
              "description": "SPARQL query string"
            },
            "kind": {
              "type": "string",
              "enum": ["sparql-select", "sparql-ask", "sparql-construct"],
              "description": "Query type"
            },
            "params": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Parameter names for prepared queries"
            }
          },
          "required": ["query"]
        }
      }
    },
    "hooks": {
      "type": "object",
      "description": "Knowledge hooks definitions",
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_]*$": {
          "type": "object",
          "properties": {
            "kind": {
              "type": "string",
              "enum": ["ask", "shacl", "delta", "threshold", "count", "window"],
              "description": "Hook type"
            },
            "query": {
              "type": "string",
              "description": "SPARQL query for ask/shacl hooks"
            },
            "config": {
              "type": "object",
              "description": "Hook-specific configuration"
            },
            "effect": {
              "type": "object",
              "properties": {
                "wasm": {
                  "type": "string",
                  "description": "WASM module path"
                },
                "exports": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "description": "Exported functions to call"
                }
              },
              "required": ["wasm"]
            }
          },
          "required": ["kind"]
        }
      }
    },
    "shapes": {
      "type": "object",
      "description": "SHACL shapes definitions",
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_]*$": {
          "type": "string",
          "description": "SHACL shapes in Turtle format"
        }
      }
    },
    "vectors": {
      "type": "object",
      "description": "Vector embedding configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "provider": {
          "type": "string",
          "enum": ["hashing", "openai", "huggingface"],
          "default": "hashing"
        },
        "model": {
          "type": "string",
          "description": "Model name for embedding providers"
        },
        "dimensions": {
          "type": "integer",
          "minimum": 1,
          "maximum": 4096,
          "default": 384
        },
        "sources": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "File patterns to extract text from"
        }
      }
    },
    "views": {
      "type": "object",
      "description": "Materialized view definitions",
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_]*$": {
          "type": "object",
          "properties": {
            "query": {
              "type": "string",
              "description": "CONSTRUCT query for the view"
            },
            "refresh": {
              "type": "string",
              "enum": ["manual", "tx", "schedule"],
              "default": "tx",
              "description": "Refresh strategy"
            },
            "schedule": {
              "type": "string",
              "description": "Cron schedule for scheduled refresh"
            }
          },
          "required": ["query"]
        }
      }
    },
    "quotas": {
      "type": "object",
      "description": "Per-namespace quotas",
      "patternProperties": {
        "^[a-zA-Z_][a-zA-Z0-9_]*$": {
          "type": "object",
          "properties": {
            "qps": {
              "type": "integer",
              "minimum": 0,
              "description": "Queries per second limit (0 = unlimited)"
            },
            "rowsps": {
              "type": "integer",
              "minimum": 0,
              "description": "Rows per second limit (0 = unlimited)"
            }
          }
        }
      }
    },
    "rollout": {
      "type": "object",
      "description": "Staged rollout configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "stable": {
          "type": "string",
          "description": "Stable pack version"
        },
        "canary": {
          "type": "string",
          "description": "Canary pack version"
        },
        "percent": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "default": 0,
          "description": "Percentage of traffic to canary"
        }
      }
    }
  },
  "required": ["version", "name"]
}
