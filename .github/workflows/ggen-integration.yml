name: ggen Integration - Ontology-Driven Code Generation

on:
  push:
    paths:
      - 'packages/*/package.json'
      - 'schema/**'
      - 'templates/**'
      - 'scripts/ggen-*.mjs'
      - 'ggen.toml'
  pull_request:
    paths:
      - 'packages/*/package.json'
      - 'schema/**'
      - 'templates/**'
      - 'scripts/ggen-*.mjs'
      - 'ggen.toml'

jobs:
  discover-and-generate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Discover packages from ontology
        run: |
          echo "üîç Discovering packages..."
          node scripts/ggen-package-discovery.mjs
          echo "‚úÖ Package discovery complete"

      - name: Generate code and documentation
        run: |
          echo "üöÄ Running integration generation..."
          node scripts/ggen-generate-integration.mjs
          echo "‚úÖ Code generation complete"

      - name: Verify generated files
        run: |
          echo "üìã Verifying generated output..."

          # Check that package docs were created
          if [ $(ls docs/packages/*.md 2>/dev/null | wc -l) -lt 50 ]; then
            echo "‚ùå Package documentation missing"
            exit 1
          fi

          # Check that exports manifest is valid JavaScript
          node -c src/generated/package-exports.mjs && echo "‚úÖ Exports manifest is valid" || exit 1

          # Check that tier summary exists
          test -f src/generated/TIER_SUMMARY.md && echo "‚úÖ Tier summary generated" || exit 1

          echo "‚úÖ All generated files verified"

      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚ö†Ô∏è  Generated files differ from committed version"
            echo "üìù Please run generation locally and commit changes:"
            echo "   node scripts/ggen-package-discovery.mjs"
            echo "   node scripts/ggen-generate-integration.mjs"
            echo "   git add docs/packages/ src/generated/ schema/packages-discovered.ttl"
            echo "   git commit -m 'feat(ggen): Update package discovery and generation'"

            # In strict mode (on main), fail the check
            if [ "${{ github.ref }}" = "refs/heads/main" ]; then
              exit 1
            fi
          else
            echo "‚úÖ Generated files are up to date"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-files
          path: |
            src/generated/
            docs/packages/
            schema/packages-discovered.ttl
          retention-days: 5

      - name: Report generation stats
        if: success()
        run: |
          echo "üìä Generation Statistics:"
          if [ -f src/generated/GENERATION_STATS.json ]; then
            cat src/generated/GENERATION_STATS.json | python3 -m json.tool
          fi

      - name: Comment on PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const stats = JSON.parse(fs.readFileSync('src/generated/GENERATION_STATS.json', 'utf-8'));

            const comment = `## ggen Integration Report

            ‚úÖ **Generation Status**: Success

            ### Statistics
            - Total Packages: ${stats.total_packages}
            - Essential Tier: ${stats.by_tier.Essential || 0}
            - Extended Tier: ${stats.by_tier.Extended || 0}
            - Optional Tier: ${stats.by_tier.Optional || 0}
            - Internal Tier: ${stats.by_tier.Internal || 0}

            ### Generated Files
            - Package Documentation: ${stats.generated_files.package_docs}
            - Tier Summary: ${stats.generated_files.tier_summary}
            - Exports Manifest: ${stats.generated_files.exports_manifest}

            Generated at: ${stats.timestamp}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
