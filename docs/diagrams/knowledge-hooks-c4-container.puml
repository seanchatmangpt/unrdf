@startuml Knowledge Hook Engine - C4 Container
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Container(hook_manager, "Knowledge Hook Manager", "JavaScript", "Central coordinator that registers\nand manages knowledge hooks\nðŸ”´ Tight coupling via TransactionManager")
Container(transaction_mgr, "Transaction Manager", "JavaScript", "Applies deltas with transactional\nguarantees and lifecycle events")
Container(hook_executor, "Hook Executor", "JavaScript", "ðŸŸ¡ Executes hooks in parallel\n(Promise.allSettled)\nNo automatic batching")
Container(batching_exec, "Batching Executor", "JavaScript", "Optional: Executes hooks\nin dependency-ordered batches\n(currently opt-in)")
Container(condition_eval, "Condition Evaluator", "JavaScript", "ðŸŸ¡ BOTTLENECK #4: Evaluates\nSPARQL-ASK conditions\n(evaluated 2Ã— per hook)")
Container(query_exec, "Query Executor", "JavaScript", "ðŸ”´ BOTTLENECK #1: Store conversion\nN3 Store â†’ Oxigraph Store\nHappens NÃ—M times per transaction")
Container(file_resolver, "File Resolver", "JavaScript", "ðŸŸ  BOTTLENECK #2: File I/O\nSHA-256 hash on every execution\n(no pre-loading)")

ContainerDb(n3_store, "N3 Store", "In-memory RDF", "Mutable N3 triple/quad store\nfor hook intermediate results")
ContainerDb(oxigraph_store, "Oxigraph Store", "WASM Engine", "Authoritative RDF storage\nwith SPARQL 1.1 support")
ContainerDb(file_cache, "File Cache (LRU)", "In-memory", "Caches 50 most recent\nfile resolutions")

Rel(hook_manager, transaction_mgr, "Extends", "Inheritance â†’ Tight coupling ðŸ”´")
Rel(transaction_mgr, hook_executor, "Executes pre-hooks", "Sequential execution ðŸŸ¡")
Rel(hook_executor, condition_eval, "For each hook:\nEvaluate condition", "2Ã— per hook ðŸŸ¡")
Rel(condition_eval, query_exec, "For SPARQL condition:\nRun query")
Rel(query_exec, n3_store, "1. Read quads", "getQuads() â†’ O(n)")
Rel(query_exec, oxigraph_store, "2. Convert store\n3. Execute SPARQL\nðŸ”´ O(n) conversion each time")
Rel(hook_executor, batching_exec, "Optional: Dependency-based\nparallel execution", "Feature flag\n(currently opt-in)")
Rel(condition_eval, file_resolver, "For file conditions:\nResolve + verify")
Rel(file_resolver, file_cache, "Check/update cache", "LRU 50 entries")
Rel(transaction_mgr, hook_executor, "Executes post-hooks", "Sequential even if independent ðŸŸ¡")

Rel(hook_executor, oxigraph_store, "Final store for\nhook effects")

note right of hook_manager
  ðŸ”´ BOTTLENECK #3: Architecture Forces Sequential Execution
  KnowledgeHookManager extends TransactionManager â†’ synchronous apply()
  Even though hooks could execute in parallel, the tight coupling
  forces sequential pre-hooks â†’ delta â†’ post-hooks
end note

note right of query_exec
  ðŸ”´ CRITICAL: Store Conversion Pattern

  const quads = store.getQuads();  // O(store.size)
  const oxStore = createStore(quads);  // O(store.size) AGAIN

  Frequency: N hooks Ã— M conditions = NÃ—M conversions
  Impact: 50-70% of transaction latency
end note

SHOW_LEGEND()
@enduml
