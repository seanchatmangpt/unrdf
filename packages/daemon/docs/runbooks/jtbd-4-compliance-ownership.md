# JTBD #4 Runbook: Ensure Compliance Team Owns Rules, Not Engineers

## Objective
Verify that deployed controls reflect compliance team decisions (not engineer preferences), with audit trail proving compliance approval.

## Prerequisites
- Ontology repository with PR history (Git or equivalent)
- Access to PR approval logs
- Compliance team roster (authorized approvers)
- Deployed receipt from production

## Steps

1. **Identify Policy Change**
   - Locate: PR that introduced ΔO (policy change)
   - Extract: Commit hash, author, reviewers, approval timestamp
   - Document: What policy changed (e.g., "Add fraud-check rule to new transaction type")

2. **Verify Compliance Team Approval**
   - Check: PR reviewers include at least one compliance team member
   - Verify: Compliance reviewer approved (not just commented)
   - Expected: Engineer cannot merge without compliance approval

3. **Review PR Discussion**
   - Read: Comments from compliance team
   - Identify: Any compliance-driven requirements
   - Example: "Engineer proposed transaction type → Compliance required fraud-check"
   - Document: Compliance team decisions that shaped final ΔO

4. **Verify No Direct Code Commits**
   - Check: Repository history for direct commits to enforcer code (A)
   - Expected: ZERO commits to A (all changes are generated from O)
   - If found: VIOLATION (engineer wrote control logic manually)

5. **Verify Receipt Binds to Approved O**
   - Retrieve: Production receipt
   - Extract: O_hash from receipt
   - Compare: `hash(O_from_approved_PR) == O_hash_from_receipt`
   - Expected: Receipt proves deployed system came from compliance-approved O

6. **Audit Constraint Violations**
   - Run: `μ validate --ontology=O_new --constraints=Σ`
   - Verify: Compliance constraints are enforced (e.g., "Segregation of Duty" rule)
   - Expected: μ rejects ΔO that violates compliance constraints

7. **Document Compliance Ownership**
   - Generate: Audit report showing compliance approval chain
   - Include: PR link, approver name, approval timestamp, receipt hash
   - Conclusion: "Controls designed by compliance team, generated by μ, zero engineer discretion"

## Success Criteria
- [ ] Policy change PR approved by compliance team (documented in PR history)
- [ ] Zero direct commits to enforcer code (all changes generated from O)
- [ ] Receipt proves: deployed system ≡ compliance-approved O
- [ ] Constraint violations rejected before generation (Jidoka/Andon)
- [ ] Doctrine invariant verified: Correct-by-Construction (O is source of truth)
- [ ] Auditor confirms: "Controls determined by compliance, not engineers"

## Troubleshooting

### If compliance approval missing from PR
- **Symptom**: PR merged without compliance team reviewer
- **Action**: PROCESS VIOLATION. This bypasses required gate
- **Fix**: Rollback deployment. Require compliance team to review ΔO retroactively. Update PR process to enforce compliance approval before merge

### If direct code commits found (engineer wrote enforcer logic)
- **Symptom**: Git history shows commits to A (enforcer code) not from μ
- **Action**: CRITICAL VIOLATION. This bypasses Correct-by-Construction principle
- **Fix**: Revert manual commits. Regenerate A from O. Audit: why did process allow manual code changes? Add pre-commit hook to block A commits

### If receipt O_hash ≠ approved PR O_hash
- **Symptom**: Production was deployed from different O than what compliance approved
- **Action**: SECURITY ISSUE. Unapproved policy is in production
- **Fix**: Immediate rollback. Investigate: who deployed unapproved O? How did deployment bypass approval gate?

### If μ validation detects constraint violation AFTER deployment
- **Symptom**: Production enforcer violates compliance constraints (e.g., SOD rule broken)
- **Action**: TPS Ontology gate failed to catch violation before generation
- **Fix**: CRITICAL. Immediate rollback. Add constraint to Σ so μ rejects violations before generation. This is a Jidoka failure (line did not stop)

### If engineer claims "compliance approved verbally"
- **Symptom**: No written approval in PR, engineer claims verbal OK
- **Action**: AUDIT DEFECT. Verbal approvals are not auditable
- **Fix**: Require written approval in PR. Verbal approvals do NOT satisfy compliance gate. Rollback deployment until written approval obtained

## References
- Test scenario: JTBD 4.1 (Compliance Team Ownership of O)
- Test scenario: JTBD 4.2 (Constraint Violation Detection)
- Doctrine invariant: Correct-by-Construction, Typing
- TPS gates: Ontology, Jidoka
- Related runbooks: JTBD #1 (Deploy Control), JTBD #2 (Audit Verification)
- Full test specification: `/home/user/unrdf/docs/finops-fabric-e2e-jtbd-tests.md` lines 207-265
