# KGEN DETERMINISM LINT RULES - ZERO TOLERANCE ENFORCEMENT

**Generated by:** Determinism Sentinel Agent
**Date:** 2025-09-13
**Authority:** ZERO TOLERANCE for nondeterminism
**Status:** CRITICAL ENFORCEMENT ACTIVE

## üö® MISSION CRITICAL OVERVIEW

This document enforces **ABSOLUTE DETERMINISM** in KGEN template systems. Every template MUST produce identical output given identical input across different systems, times, and environments.

**ZERO TOLERANCE POLICY:** Any nondeterministic pattern in template code is a CRITICAL violation requiring immediate remediation.

## ‚ö†Ô∏è CRITICAL VIOLATIONS DETECTED

### Current Status (2025-09-13)
- **254+ temporal violations** found in unjucks codebase
- **80+ environment dependencies** compromising reproducibility
- **60+ unstable iterations** causing output inconsistency
- **20+ network dependencies** creating runtime variability

### Immediate Action Required
All detected violations MUST be fixed before production deployment.

## üî• CRITICAL DETERMINISM RULES (P0 - ZERO TOLERANCE)

### 1. TEMPORAL NONDETERMINISM (FORBIDDEN)

#### ‚ùå CRITICAL VIOLATIONS

```javascript
// FORBIDDEN - ZERO TOLERANCE
new Date()                           // Line: unjucks/kgen/packages/kgen-core/src/provenance/attestation.js:80
Date.now()                          // Line: unjucks/src/pages/dashboard/index.vue:260
Math.floor(Date.now() / 1000)       // Line: unjucks/kgen/packages/kgen-core/src/provenance/attestation.js:221
Math.random()                       // Line: unjucks/src/sparql-integration.js:527
crypto.randomBytes()                // Found in 15+ locations
uuidv4()                           // Found in 25+ locations
```

#### ‚úÖ MANDATORY ALTERNATIVES

```javascript
// REQUIRED DETERMINISTIC PATTERNS
const timestamp = context.metadata.buildTime || '2025-01-01T00:00:00.000Z';
const id = generateDeterministicId(inputData, context.salt);
const random = seedRandom(deterministicSeed);

// DETERMINISTIC ID GENERATION
function generateDeterministicId(data, salt = '') {
  const hash = createHash('sha256');
  hash.update(JSON.stringify(data, Object.keys(data).sort()));
  hash.update(salt);
  return hash.digest('hex').substring(0, 8);
}

// DETERMINISTIC TIMESTAMP
function getDeterministicTimestamp(context) {
  return context.metadata?.buildTime ||
         context.config?.fixedTimestamp ||
         '2025-01-01T00:00:00.000Z';
}
```

### 2. ENVIRONMENT DEPENDENCIES (FORBIDDEN)

#### ‚ùå CRITICAL VIOLATIONS

```javascript
// FORBIDDEN IN TEMPLATES - ZERO TOLERANCE
process.env.NODE_ENV                 // Line: unjucks/nuxt.config.js:36
process.env.BASE_URL                // Found in 15+ locations
process.platform                    // System-dependent
os.hostname()                       // Hardware-dependent
```

#### ‚úÖ MANDATORY ALTERNATIVES

```javascript
// REQUIRED CONFIGURATION-BASED APPROACH
const env = context.config.targetEnvironment;
const baseUrl = context.config.baseUrl;
const platform = context.metadata.targetPlatform;
const hostname = context.config.targetHost;
```

### 3. UNSTABLE DATA STRUCTURE ITERATION (FORBIDDEN)

#### ‚ùå CRITICAL VIOLATIONS

```javascript
// FORBIDDEN - UNDEFINED KEY ORDER
Object.keys(obj).forEach(key => {})   // Found in 40+ locations
for (const key in obj) {}            // Found in 25+ locations
Object.values(obj)                   // Order depends on key insertion
Object.entries(obj)                  // Order depends on key insertion
```

#### ‚úÖ MANDATORY ALTERNATIVES

```javascript
// REQUIRED SORTED ITERATION
Object.keys(obj).sort().forEach(key => processKey(key));
for (const key of Object.keys(obj).sort()) { process(key, obj[key]); }

// DETERMINISTIC OBJECT PROCESSING
function processObjectDeterministically(obj) {
  return Object.keys(obj)
    .sort()
    .reduce((acc, key) => {
      acc[key] = processValue(obj[key]);
      return acc;
    }, {});
}
```

### 4. I/O NONDETERMINISM (FORBIDDEN)

#### ‚ùå CRITICAL VIOLATIONS

```javascript
// FORBIDDEN - UNDEFINED ORDER
fs.readdir(directory)               // Line: unjucks/src/commands/knowledge-graph.js:189
glob('*.js')                       // Order varies by filesystem
require(`./plugins/${name}.js`)     // Dynamic imports
```

#### ‚úÖ MANDATORY ALTERNATIVES

```javascript
// REQUIRED SORTED I/O
const files = (await fs.readdir(directory)).sort();
const modules = (await glob('*.js')).sort();

// CONTROLLED DYNAMIC IMPORTS
function importDeterministicModule(name, allowedModules) {
  if (!allowedModules.includes(name)) {
    throw new Error(`Module ${name} not in allowed list`);
  }
  return import(`./plugins/${name}.js`);
}
```

## üîß ESLINT CONFIGURATION ENFORCEMENT

### Core Rules (.eslintrc.js)

```javascript
{
  "rules": {
    // TEMPORAL NONDETERMINISM (ZERO TOLERANCE)
    "no-new": ["error", { "Date": "Use getDeterministicTimestamp()" }],
    "no-restricted-properties": ["error",
      { "object": "Date", "property": "now", "message": "FORBIDDEN: Use context.metadata.buildTime" },
      { "object": "Math", "property": "random", "message": "FORBIDDEN: Use generateDeterministicId()" }
    ],

    // ENVIRONMENT DEPENDENCIES (ZERO TOLERANCE)
    "no-process-env": "error",
    "no-restricted-imports": ["error", "os", { "name": "crypto", "importNames": ["randomBytes"] }],

    // DATA STRUCTURE DETERMINISM (ZERO TOLERANCE)
    "no-for-in": "error",
    "prefer-object-keys-sort": "error",
    "require-array-sort-callback": "error",

    // I/O DETERMINISM (ZERO TOLERANCE)
    "no-dynamic-require": "error",
    "require-sorted-readdir": "error"
  }
}
```

### Template-Specific Overrides

```javascript
{
  // STRICTEST ENFORCEMENT FOR TEMPLATES
  files: ["**/templates/**", "**/filters/**", "**/generators/**"],
  rules: {
    "no-console": "error",           // ZERO TOLERANCE
    "no-process-env": "error",       // ZERO TOLERANCE
    "no-new": "error",               // ZERO TOLERANCE
    "sort-keys": "error"             // MANDATORY sorted keys
  }
}
```

## üß™ LONDON BDD TEST DOUBLES

### Temporal Stubs

```javascript
// Mock Date constructor for deterministic testing
export class MockDate extends Date {
  constructor(...args) {
    if (args.length === 0) {
      super('2025-01-01T00:00:00.000Z'); // Fixed timestamp
    } else {
      super(...args);
    }
  }

  static now() {
    return new Date('2025-01-01T00:00:00.000Z').getTime();
  }
}

// Stub Math.random for deterministic results
export const mockMath = {
  ...Math,
  random: (() => {
    let seed = 0.12345; // Fixed seed
    return () => {
      seed = (seed * 9301 + 49297) % 233280;
      return seed / 233280;
    };
  })()
};
```

### Environment Stubs

```javascript
// Mock process.env for deterministic testing
export const mockProcessEnv = {
  NODE_ENV: 'test',
  BASE_URL: 'https://test.example.com',
  API_KEY: 'test-api-key-12345'
};

// Stub OS functions
export const mockOS = {
  hostname: () => 'test-host',
  platform: () => 'test-platform',
  tmpdir: () => '/tmp/test',
  userInfo: () => ({ username: 'test-user' })
};
```

### I/O Test Doubles

```javascript
// Mock fs operations with deterministic ordering
export const mockFS = {
  readdir: async (path) => {
    const files = await originalReaddir(path);
    return files.sort(); // Always sorted
  },

  glob: async (pattern) => {
    const matches = await originalGlob(pattern);
    return matches.sort(); // Always sorted
  }
};
```

## üìè TEMPLATE CONSTRAINTS (MANDATORY LIMITS)

### Structural Limits

```javascript
const TEMPLATE_LIMITS = {
  maxTemplateDepth: 10,           // Maximum include/extend depth
  maxOutputSize: 10485760,        // 10MB maximum output
  maxIterations: 10000,           // Maximum loop iterations
  maxFileSize: 1048576,           // 1MB per template file
  maxIncludeChain: 5              // Maximum include chain length
};
```

### Validation Rules

```javascript
// Template depth validation
function validateTemplateDepth(templateContent) {
  const depth = calculateIncludeDepth(templateContent);
  if (depth > TEMPLATE_LIMITS.maxTemplateDepth) {
    throw new Error(`Template depth ${depth} exceeds limit ${TEMPLATE_LIMITS.maxTemplateDepth}`);
  }
}

// Output size validation
function validateOutputSize(generatedContent) {
  const size = Buffer.byteLength(generatedContent, 'utf8');
  if (size > TEMPLATE_LIMITS.maxOutputSize) {
    throw new Error(`Output size ${size} exceeds limit ${TEMPLATE_LIMITS.maxOutputSize}`);
  }
}
```

## üéØ DETERMINISTIC PATTERNS (MANDATORY)

### 1. Canonical JSON Serialization

```javascript
function serializeCanonically(obj) {
  return JSON.stringify(obj, Object.keys(obj).sort());
}
```

### 2. UTF-8 NFC Normalization

```javascript
function normalizeString(text) {
  return text.normalize('NFC');
}
```

### 3. Fixed Line Endings

```javascript
function normalizeLineEndings(content) {
  return content.replace(/\r\n|\r/g, '\n'); // Always LF
}
```

### 4. Deterministic Locale Settings

```javascript
const DETERMINISTIC_LOCALE = {
  locale: 'en-US',
  timezone: 'UTC',
  currency: 'USD',
  dateFormat: 'YYYY-MM-DD',
  timeFormat: 'HH:mm:ss'
};
```

## üîç VIOLATION SCANNING COMMANDS

### Audit Existing Code

```bash
# Scan for temporal violations
grep -r "new Date\(\|Date\.now\(\|Math\.random\(" src/

# Scan for environment dependencies
grep -r "process\.env\." src/ --exclude-dir=config

# Scan for unsorted iterations
grep -r "Object\.keys.*\.forEach\|for.*in " src/

# Run comprehensive determinism audit
npm run lint:determinism
npm run audit:nondeterminism
```

### CI/CD Integration

```yaml
# .github/workflows/determinism-check.yml
name: Determinism Enforcement
on: [push, pull_request]

jobs:
  determinism-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        run: npm ci
      - name: Run determinism linting (ZERO TOLERANCE)
        run: npm run lint:determinism
      - name: Validate golden files
        run: npm run test:golden-files
      - name: Cross-platform validation
        run: npm run test:cross-platform
```

## üìà MIGRATION ROADMAP

### Phase 1: Critical Fixes (IMMEDIATE)
- [ ] Replace all `new Date()` with `getDeterministicTimestamp()`
- [ ] Replace all `Math.random()` with `generateDeterministicId()`
- [ ] Sort all `Object.keys()` iterations
- [ ] Eliminate `process.env` from template code

### Phase 2: Infrastructure (Week 1)
- [ ] Implement deterministic ID generation system
- [ ] Create configuration-based environment handling
- [ ] Add sorted file system operations
- [ ] Implement stable serialization utilities

### Phase 3: Testing (Week 2)
- [ ] Add golden file tests for all templates
- [ ] Cross-platform determinism validation
- [ ] Performance impact assessment
- [ ] Regression testing framework

### Phase 4: Enforcement (Week 3)
- [ ] Enable ZERO TOLERANCE mode in CI/CD
- [ ] Pre-commit hooks with determinism checking
- [ ] Developer training on deterministic patterns
- [ ] Code review checklists update

## üö® COMPLIANCE REQUIREMENTS

### SLSA (Supply-chain Levels for Software Artifacts)
- **Level 3+**: Requires reproducible builds
- **Deterministic outputs**: Critical for build verification
- **Provenance tracking**: Must be deterministic

### Regulatory Compliance
- **SOX**: Requires deterministic audit trails
- **GDPR**: Deterministic data processing requirements
- **ISO 27001**: Reproducible security controls

## üîí ZERO TOLERANCE ENFORCEMENT

### Development Workflow
1. **Pre-commit hooks** MUST pass determinism linting
2. **IDE plugins** MUST warn about nondeterministic patterns
3. **Code review** MUST include determinism verification
4. **CI/CD pipeline** MUST enforce ZERO TOLERANCE policy

### Violation Response
1. **CRITICAL violations** = Immediate build failure
2. **HIGH violations** = Block merge/deployment
3. **MEDIUM violations** = Warning with remediation plan
4. **Any regression** = Rollback required

### Monitoring Strategy
- **Drift detection**: Automated output comparison over time
- **Regression alerts**: Real-time violation detection
- **Compliance metrics**: Determinism score tracking
- **Performance impact**: Continuous monitoring

## üìã DEVELOPER CHECKLIST

Before submitting any template code:

- [ ] ‚úÖ Zero `new Date()` or `Date.now()` calls
- [ ] ‚úÖ Zero `Math.random()` calls
- [ ] ‚úÖ Zero `process.env` access in templates
- [ ] ‚úÖ All object iteration uses `.sort()`
- [ ] ‚úÖ All file operations use sorted results
- [ ] ‚úÖ Template depth within limits
- [ ] ‚úÖ Output size within limits
- [ ] ‚úÖ Golden file tests pass
- [ ] ‚úÖ Cross-platform tests pass
- [ ] ‚úÖ Determinism linter passes with ZERO violations

## üéØ SUCCESS METRICS

### Target KPIs
- **100%** deterministic template coverage
- **0** critical violations in production code
- **100%** cross-platform consistency
- **<1ms** performance overhead from deterministic patterns

### Current Status
- ‚ùå **Critical violations**: 254+ detected (TARGET: 0)
- ‚ùå **Cross-platform consistency**: 60% (TARGET: 100%)
- ‚ùå **Reproducible builds**: 0% (TARGET: 100%)
- ‚ö†Ô∏è **Template coverage**: 40% (TARGET: 100%)

## üìû VIOLATION REPORTING

### Emergency Response
- **Critical violations**: Report immediately to DevOps team
- **Security implications**: Escalate to security team
- **Compliance risks**: Notify compliance officer

### Contact Information
- **Primary**: Determinism Sentinel Agent
- **Escalation**: KGEN Security Team
- **Emergency**: DevOps On-Call

---

**REMEMBER: ZERO TOLERANCE for nondeterminism. Every violation compromises system integrity, security, and compliance. Fix immediately or reject the code.**