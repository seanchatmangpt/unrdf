/**
 * KGEN Macro Templates - Reusable template components
 * 
 * Provides a library of pre-built macros for common template patterns
 * All macros are deterministic and compatible with KGEN template engine
 */

export class KGenMacroTemplates {
  constructor(options = {}) {
    this.options = {
      deterministicMode: options.deterministicMode !== false,
      staticBuildTime: options.staticBuildTime || '2024-01-01T00:00:00.000Z',
      namespace: options.namespace || 'kgen',
      ...options
    };
    
    this.macros = new Map();
    this.initializeMacros();
  }

  /**
   * Initialize built-in macro templates
   */
  initializeMacros() {
    // Document structure macros
    this.registerMacro('document_header', `{%- macro document_header(title, author, version='1.0.0') -%}
/**
 * {{ title }}
 * 
 * @author {{ author | default('KGEN Generator') }}
 * @version {{ version }}
 * @generated {{ __kgen.renderTime }}
 * @hash {{ (title + author + version) | hash | shortHash(8) }}
 */
{%- endmacro -%}`);

    this.registerMacro('code_block', `{%- macro code_block(content, language='javascript', indent=0) -%}
{%- set indentStr = ' '.repeat(indent) -%}
{{ indentStr }}\`\`\`{{ language }}
{%- for line in content.split('\n') %}
{{ indentStr }}{{ line }}
{%- endfor %}
{{ indentStr }}\`\`\`
{%- endmacro -%}`);

    this.registerMacro('json_schema', `{%- macro json_schema(schema, indent=2) -%}
{%- set indentStr = ' '.repeat(indent) -%}
{{ indentStr }}{{
{%- for key, value in schema.items() %}
{{ indentStr }}  "{{ key }}": {{ value | json }}{%- if not loop.last %},{% endif %}
{%- endfor %}
{{ indentStr }}}
{%- endmacro -%}`);

    // HTML/Web macros
    this.registerMacro('html_form', `{%- macro html_form(fields, action='#', method='POST', cssClass='kgen-form') -%}
<form action="{{ action }}" method="{{ method }}" class="{{ cssClass }}">
{%- for field in fields %}
  <div class="form-group">
    {%- if field.label %}
    <label for="{{ field.name }}">{{ field.label }}</label>
    {%- endif %}
    <input 
      type="{{ field.type | default('text') }}"
      name="{{ field.name }}"
      id="{{ field.name }}"
      {%- if field.required %} required{% endif %}
      {%- if field.placeholder %} placeholder="{{ field.placeholder }}"{% endif %}
      {%- if field.value %} value="{{ field.value }}"{% endif %}
      class="form-control"
    >
  </div>
{%- endfor %}
  <button type="submit" class="btn btn-primary">Submit</button>
</form>
{%- endmacro -%}`);

    this.registerMacro('html_table', `{%- macro html_table(data, headers=[], cssClass='kgen-table') -%}
<table class="{{ cssClass }}">
  {%- if headers | length > 0 %}
  <thead>
    <tr>
    {%- for header in headers %}
      <th>{{ header }}</th>
    {%- endfor %}
    </tr>
  </thead>
  {%- endif %}
  <tbody>
  {%- for row in data %}
    <tr>
    {%- if row is mapping %}
      {%- for key in (headers if headers else row.keys()) %}
      <td>{{ row[key] | default('') }}</td>
      {%- endfor %}
    {%- else %}
      {%- for cell in row %}
      <td>{{ cell }}</td>
      {%- endfor %}
    {%- endif %}
    </tr>
  {%- endfor %}
  </tbody>
</table>
{%- endmacro -%}`);

    // Code generation macros
    this.registerMacro('js_class', `{%- macro js_class(className, methods=[], imports=[], exports=true) -%}
{%- if imports | length > 0 %}
{%- for import in imports %}
import {{ import.name }}{{ import.from ? ' from \'' + import.from + '\'' : '' }};
{%- endfor %}

{%- endif %}
{%- if exports %}export {% endif %}class {{ className }} {
  constructor(options = {}) {
    this.options = { ...options };
  }
{%- for method in methods %}

  {{ method.name }}({{ method.params | default('') }}) {
    {{ method.body | default('// Method implementation') | indent(4) }}
  }
{%- endfor %}
}
{%- if exports %}

export default {{ className }};
{%- endif %}
{%- endmacro -%}`);

    this.registerMacro('js_function', `{%- macro js_function(name, params=[], body='', isAsync=false, isExport=false) -%}
{%- if isExport %}export {% endif %}{%- if isAsync %}async {% endif %}function {{ name }}({{ params | join(', ') }}) {
{{ body | indent(2) }}
}
{%- endmacro -%}`);

    this.registerMacro('js_module', `{%- macro js_module(name, description='', imports=[], exports=[], constants=[]) -%}
/**
 * {{ name }}
 * {%- if description %}
 * {{ description }}
 * {%- endif %}
 * 
 * @generated {{ __kgen.renderTime }}
 */

{%- if imports | length > 0 %}
{%- for import in imports %}
import {{ import.name }}{{ import.from ? ' from \'' + import.from + '\'' : '' }};
{%- endfor %}

{%- endif %}
{%- if constants | length > 0 %}
{%- for constant in constants %}
const {{ constant.name }} = {{ constant.value | json }};
{%- endfor %}

{%- endif %}
// Module content goes here

{%- if exports | length > 0 %}
// Exports
{%- for export in exports %}
export {{ export.type | default('') }} {{ export.name }}{{ export.value ? ' = ' + export.value : '' }};
{%- endfor %}
{%- endif %}
{%- endmacro -%}`);

    // Configuration macros
    this.registerMacro('config_json', `{%- macro config_json(config, indent=2) -%}
{
{%- for key, value in config.items() %}
{{ ' '.repeat(indent) }}"{{ key }}": {{ value | json }}{%- if not loop.last %},{% endif %}
{%- endfor %}
}
{%- endmacro -%}`);

    this.registerMacro('env_file', `{%- macro env_file(vars) -%}
# Environment Configuration
# Generated {{ __kgen.renderTime }}

{%- for key, value in vars.items() %}
{{ key }}={{ value }}
{%- endfor %}
{%- endmacro -%}`);

    // Documentation macros
    this.registerMacro('api_doc', `{%- macro api_doc(endpoint, method='GET', params=[], responses=[]) -%}
## {{ method.upper() }} {{ endpoint }}

{%- if params | length > 0 %}
### Parameters

| Name | Type | Required | Description |
|------|------|----------|-------------|
{%- for param in params %}
| {{ param.name }} | {{ param.type | default('string') }} | {{ 'Yes' if param.required else 'No' }} | {{ param.description | default('') }} |
{%- endfor %}
{%- endif %}

{%- if responses | length > 0 %}
### Responses

{%- for response in responses %}
#### {{ response.code }} - {{ response.description }}

{%- if response.schema %}
```json
{{ response.schema | json(2) }}
```
{%- endif %}
{%- endfor %}
{%- endif %}
{%- endmacro -%}`);

    this.registerMacro('readme_section', `{%- macro readme_section(title, content, level=2) -%}
{{ '#'.repeat(level) }} {{ title }}

{{ content }}
{%- endmacro -%}`);

    // Testing macros
    this.registerMacro('test_suite', `{%- macro test_suite(name, tests=[], setup='', teardown='') -%}
describe('{{ name }}', () => {
{%- if setup %}
  beforeEach(() => {
{{ setup | indent(4) }}
  });
{%- endif %}

{%- for test in tests %}
  it('{{ test.description }}', {{ 'async ' if test.async }}() => {
{{ test.body | indent(4) }}
  });
{%- endfor %}

{%- if teardown %}
  afterEach(() => {
{{ teardown | indent(4) }}
  });
{%- endif %}
});
{%- endmacro -%}`);

    // Utility macros
    this.registerMacro('copyright_notice', `{%- macro copyright_notice(year, holder, license='MIT') -%}
/**
 * Copyright (c) {{ year }} {{ holder }}
 * 
 * Licensed under the {{ license }} License
 * Generated by KGEN {{ __kgen.renderTime }}
 */
{%- endmacro -%}`);

    this.registerMacro('todo_comment', `{%- macro todo_comment(description, priority='NORMAL', assignee='') -%}
// TODO{{ '(' + priority + ')' if priority != 'NORMAL' }}{{ ': @' + assignee if assignee }}: {{ description }}
{%- endmacro -%}`);

    this.registerMacro('version_info', `{%- macro version_info(version, date, changes=[]) -%}
/**
 * Version: {{ version }}
 * Date: {{ date }}
 * {%- if changes | length > 0 %}
 * Changes:
 {%- for change in changes %}
 *   - {{ change }}
 {%- endfor %}
 * {%- endif %}
 */
{%- endmacro -%}`);
  }

  /**
   * Register a macro template
   */
  registerMacro(name, template, metadata = {}) {
    this.macros.set(name, {
      template,
      metadata: {
        name,
        registered: this.options.staticBuildTime,
        namespace: this.options.namespace,
        deterministic: true,
        ...metadata
      }
    });
  }

  /**
   * Get macro template by name
   */
  getMacro(name) {
    return this.macros.get(name);
  }

  /**
   * Get all macro names
   */
  getMacroNames() {
    return Array.from(this.macros.keys()).sort();
  }

  /**
   * Get macros by category
   */
  getMacrosByCategory(category) {
    const macros = [];
    
    for (const [name, macro] of this.macros) {
      if (macro.metadata.category === category) {
        macros.push({ name, ...macro });
      }
    }
    
    return macros.sort((a, b) => a.name.localeCompare(b.name));
  }

  /**
   * Generate macro library as template content
   */
  generateMacroLibrary(macroNames = []) {
    const macrosToInclude = macroNames.length > 0 
      ? macroNames.filter(name => this.macros.has(name))
      : Array.from(this.macros.keys());
    
    const content = [];
    
    content.push('{% comment %}');
    content.push('KGEN Macro Library');
    content.push(`Generated: ${this.options.staticBuildTime}`);
    content.push(`Macros: ${macrosToInclude.length}`);
    content.push('{% endcomment %}');
    content.push('');
    
    for (const name of macrosToInclude.sort()) {
      const macro = this.macros.get(name);
      if (macro) {
        content.push(`{% comment %} Macro: ${name} {% endcomment %}`);
        content.push(macro.template);
        content.push('');
      }
    }
    
    return content.join('\n');
  }

  /**
   * Export macros for external use
   */
  exportMacros(format = 'kgen') {
    const exported = {
      format,
      generated: this.options.staticBuildTime,
      namespace: this.options.namespace,
      macros: {}
    };
    
    for (const [name, macro] of this.macros) {
      exported.macros[name] = {
        template: macro.template,
        metadata: macro.metadata
      };
    }
    
    return exported;
  }

  /**
   * Import macros from external source
   */
  importMacros(macroData, options = {}) {
    const { overwrite = false, prefix = '' } = options;
    
    if (!macroData || !macroData.macros) {
      throw new Error('Invalid macro data format');
    }
    
    const imported = [];
    
    for (const [name, macro] of Object.entries(macroData.macros)) {
      const macroName = prefix + name;
      
      if (!overwrite && this.macros.has(macroName)) {
        continue;
      }
      
      this.registerMacro(macroName, macro.template, {
        ...macro.metadata,
        imported: true,
        importedFrom: macroData.namespace || 'unknown'
      });
      
      imported.push(macroName);
    }
    
    return imported;
  }

  /**
   * Validate macro template syntax
   */
  validateMacro(name) {
    const macro = this.macros.get(name);
    if (!macro) {
      throw new Error(`Macro '${name}' not found`);
    }
    
    // Basic syntax validation
    const template = macro.template;
    const errors = [];
    
    // Check for balanced tags
    const macroStart = template.match(/{%-?\s*macro\s+/g) || [];
    const macroEnd = template.match(/{%-?\s*endmacro\s*-?%}/g) || [];
    
    if (macroStart.length !== macroEnd.length) {
      errors.push('Unbalanced macro tags');
    }
    
    // Check for invalid syntax patterns
    if (template.includes('{% macro %}') || template.includes('{%- macro -%}')) {
      errors.push('Macro definition missing name');
    }
    
    return {
      valid: errors.length === 0,
      errors
    };
  }

  /**
   * Get macro statistics
   */
  getStats() {
    const stats = {
      total: this.macros.size,
      categories: {},
      imported: 0,
      invalid: 0
    };
    
    for (const [name, macro] of this.macros) {
      const category = macro.metadata.category || 'general';
      stats.categories[category] = (stats.categories[category] || 0) + 1;
      
      if (macro.metadata.imported) {
        stats.imported++;
      }
      
      const validation = this.validateMacro(name);
      if (!validation.valid) {
        stats.invalid++;
      }
    }
    
    return stats;
  }
}

export default KGenMacroTemplates;