/**
 * @fileoverview Navigation generator for Nextra _meta.json files
 * Creates sidebar navigation from scanned packages
 */

/**
 * Generate _meta.json for Nextra navigation
 * @param {Object} groupedFiles - Files grouped by package/module
 * @param {Object} options - Generation options
 * @returns {Object} Nextra _meta.json structure
 */
export function generateNavigation(groupedFiles, options = {}) {
  const {
    rootTitle = 'API Reference',
    includeIndex = true,
  } = options;

  const meta = {
    index: includeIndex ? 'Overview' : undefined,
  };

  // Add each package to navigation
  Object.entries(groupedFiles).forEach(([pkgName, pkgData]) => {
    const pkgKey = `api/${pkgName}`;

    // Package entry
    meta[pkgKey] = {
      title: `@unrdf/${pkgName}`,
      type: 'page',
    };

    // Add modules within package
    Object.keys(pkgData.modules).forEach(moduleName => {
      if (moduleName === 'root') {
        // Files in root of src/ - add directly under package
        meta[`${pkgKey}/index`] = `${pkgName} API`;
      } else {
        // Submodule
        meta[`${pkgKey}/${moduleName}`] = {
          title: moduleName.charAt(0).toUpperCase() + moduleName.slice(1),
        };
      }
    });
  });

  return meta;
}

/**
 * Generate package index page content
 * @param {string} packageName - Package name
 * @param {Object} packageData - Package data from scanner
 * @returns {string} MDX content for package index
 */
export function generatePackageIndex(packageName, packageData) {
  const { modules, relativePath } = packageData;
  const moduleNames = Object.keys(modules);

  return `# @unrdf/${packageName}

> Package: \`${relativePath}\`

## Modules

This package contains ${moduleNames.length} module${moduleNames.length !== 1 ? 's' : ''}:

${moduleNames.map(name => {
  const files = modules[name];
  return `### ${name === 'root' ? 'Core' : name.charAt(0).toUpperCase() + name.slice(1)}

${files.length} source file${files.length !== 1 ? 's' : ''}

${files.slice(0, 5).map(f => {
  const fileName = f.split('/').pop();
  const moduleLink = name === 'root' ? fileName.replace(/\.(m?js)$/, '') : `${name}/${fileName.replace(/\.(m?js)$/, '')}`;
  return `- [\`${fileName}\`](./${moduleLink})`;
}).join('\n')}

${files.length > 5 ? `\n...and ${files.length - 5} more` : ''}
`;
}).join('\n')}

---

*Generated by @unrdf/kgn documentation generator*
`;
}

/**
 * Generate root API index page
 * @param {Object} groupedFiles - All packages and modules
 * @returns {string} MDX content for API index
 */
export function generateAPIIndex(groupedFiles) {
  const packages = Object.entries(groupedFiles);

  return `# API Reference

Welcome to the @unrdf workspace API reference.

## Packages

The workspace contains ${packages.length} package${packages.length !== 1 ? 's' : ''}:

${packages.map(([pkgName, pkgData]) => {
  const moduleCount = Object.keys(pkgData.modules).length;
  const fileCount = pkgData.sourceFiles.length;

  return `### [@unrdf/${pkgName}](./${pkgName})

${moduleCount} module${moduleCount !== 1 ? 's' : ''}, ${fileCount} source file${fileCount !== 1 ? 's' : ''}

${pkgData.modules ? Object.keys(pkgData.modules).slice(0, 3).map(m =>
  `- ${m === 'root' ? 'Core' : m}`
).join('\n') : ''}
${moduleCount > 3 ? `- ...and ${moduleCount - 3} more` : ''}
`;
}).join('\n')}

---

## Search

Use the search bar above to find specific functions, classes, or modules.

---

*Documentation generated from JSDoc comments using @unrdf/kgn*
`;
}

export default {
  generateNavigation,
  generatePackageIndex,
  generateAPIIndex,
};
